<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>materialender</title>
  <style>
    /* Material Design Inspired Styles */
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #f5f5f5;
    }
    #app-container {
      padding: 24px;
    }
    .fc { /* FullCalendar container */
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .fc-header-toolbar {
      padding: 16px;
      background-color: #6200ee;
      color: #ffffff;
      border-radius: 8px 8px 0 0;
    }
    .fc-toolbar-title {
      font-size: 1.25rem;
    }
    .fc-button {
      background-color: #6200ee !important;
      border: none !important;
      box-shadow: none !important;
    }
    .fc-button:hover {
      background-color: #7c4dff !important;
    }
    .fc-daygrid-day-number {
      padding: 8px;
    }
    .fc-day-today {
      background-color: #e8eaf6 !important;
    }
    .fc-event {
      border: none !important;
      color: #ffffff !important;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
    }
    #search-container {
      margin-bottom: 16px;
    }
    #eventSearch {
      width: 100%;
      padding: 12px 20px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    input[type=text], input[type=datetime-local], select, input[type=number] {
      width: 100%;
      padding: 12px 20px;
      margin: 8px 0;
      display: inline-block;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      background-color: #6200ee;
      color: white;
      padding: 14px 20px;
      margin: 8px 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #7c4dff;
    }
    #deleteEvent {
      background-color: #f44336;
    }
    #deleteEvent:hover {
      background-color: #e57373;
    }
  </style>
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
</head>
<body>

  <div id="app-container">
    <div id="search-container">
      <input type="text" id="eventSearch" placeholder="Search for events...">
    </div>
    <div id="calendar"></div>
  </div>

  <!-- Event Modal -->
  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2 id="modalTitle">Add Event</h2>
      <input type="hidden" id="eventId">
      <label for="eventTitle">Event Title</label>
      <input type="text" id="eventTitle" placeholder="Event Title">
      <label for="eventStart">Start Time</label>
      <input type="datetime-local" id="eventStart">
      <label for="eventEnd">End Time</label>
      <input type="datetime-local" id="eventEnd">
      <label>
        <input type="checkbox" id="allDay"> All-day event
      </label>
      <br><br>
      <label for="eventCategory">Category</label>
      <select id="eventCategory">
        <option value="#03a9f4">Default</option>
        <option value="#f44336">Work</option>
        <option value="#4caf50">Personal</option>
        <option value="#ff9800">Urgent</option>
      </select>
      <label for="eventReminder">Reminder (minutes before)</label>
      <input type="number" id="eventReminder" placeholder="e.g., 15">
      <button id="saveEvent">Save</button>
      <button id="deleteEvent" style="display:none;">Delete</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // IndexedDB Setup
      let db;
      const dbRequest = indexedDB.open('materialenderDB', 1);

      dbRequest.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains('events')) {
          db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
        }
      };

      dbRequest.onsuccess = function(event) {
        db = event.target.result;
        loadEventsFromDB();
      };

      dbRequest.onerror = function(event) {
        console.error('Database error:', event.target.errorCode);
      };

      // Calendar and Modal Elements
      var calendarEl = document.getElementById('calendar');
      var modal = document.getElementById('eventModal');
      var closeButton = document.getElementsByClassName('close-button')[0];
      var saveEventButton = document.getElementById('saveEvent');
      var deleteEventButton = document.getElementById('deleteEvent');
      var modalTitle = document.getElementById('modalTitle');
      var eventIdInput = document.getElementById('eventId');
      var eventTitleInput = document.getElementById('eventTitle');
      var eventStartInput = document.getElementById('eventStart');
      var eventEndInput = document.getElementById('eventEnd');
      var allDayCheckbox = document.getElementById('allDay');
      var eventCategoryInput = document.getElementById('eventCategory');
      var eventReminderInput = document.getElementById('eventReminder');
      var searchInput = document.getElementById('eventSearch');
      var currentEventInfo = null;

      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: true,
        selectable: true,
        select: function(info) {
          currentEventInfo = { startStr: info.startStr, endStr: info.endStr, event: null };
          openModal();
        },
        eventClick: function(info) {
          currentEventInfo = { event: info.event };
          openModal();
        },
        eventDrop: function(info) {
          updateEventInDB(info.event);
        },
        eventResize: function(info) {
            updateEventInDB(info.event);
        }
      });

      calendar.render();

      function loadEventsFromDB() {
        if (!db) return;
        const transaction = db.transaction(['events'], 'readonly');
        const objectStore = transaction.objectStore('events');
        const request = objectStore.getAll();

        request.onsuccess = function() {
          const events = request.result.map(e => ({
            ...e,
            start: e.start, // Ensure dates are in correct format
            end: e.end,
            backgroundColor: e.category,
            borderColor: e.category
          }));
          calendar.removeAllEvents();
          calendar.addEventSource(events);
        };
      }
      
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const events = calendar.getEvents();
        events.forEach(event => {
          if (event.title.toLowerCase().includes(searchTerm)) {
            event.setProp('display', 'auto');
          } else {
            event.setProp('display', 'none');
          }
        });
      });

      function openModal() {
        modal.style.display = 'block';
        const event = currentEventInfo ? currentEventInfo.event : null;

        if (event) {
          modalTitle.innerText = 'Edit Event';
          eventIdInput.value = event.extendedProps.id;
          eventTitleInput.value = event.title;
          eventStartInput.value = event.startStr.slice(0, 16);
          eventEndInput.value = event.endStr ? event.endStr.slice(0, 16) : '';
          allDayCheckbox.checked = event.allDay;
          eventCategoryInput.value = event.backgroundColor || '#03a9f4';
          eventReminderInput.value = event.extendedProps.reminder || '';
          deleteEventButton.style.display = 'block';
        } else {
          modalTitle.innerText = 'Add Event';
          eventIdInput.value = '';
          eventTitleInput.value = '';
          eventStartInput.value = currentEventInfo.startStr;
          eventEndInput.value = currentEventInfo.endStr;
          allDayCheckbox.checked = false;
          eventCategoryInput.value = '#03a9f4';
          eventReminderInput.value = '';
          deleteEventButton.style.display = 'none';
        }
      }

      function closeModal() {
        modal.style.display = 'none';
        currentEventInfo = null;
      }

      closeButton.onclick = closeModal;
      window.onclick = function(event) {
        if (event.target == modal) {
          closeModal();
        }
      };

      saveEventButton.onclick = function() {
        const title = eventTitleInput.value;
        const start = eventStartInput.value;
        const end = eventEndInput.value;
        const allDay = allDayCheckbox.checked;
        const category = eventCategoryInput.value;
        const reminder = eventReminderInput.value;

        if (!title || !start) {
          alert('Please enter a title and start time.');
          return;
        }

        const eventData = {
          title: title,
          start: allDay ? start.split('T')[0] : start,
          end: allDay ? null : end,
          allDay: allDay,
          category: category,
          reminder: reminder
        };

        const transaction = db.transaction(['events'], 'readwrite');
        const objectStore = transaction.objectStore('events');

        if (eventIdInput.value) { // Update
          eventData.id = parseInt(eventIdInput.value);
          objectStore.put(eventData);
        } else { // Add new
          objectStore.add(eventData);
        }

        transaction.oncomplete = function() {
          loadEventsFromDB();
          setReminder(eventData);
          closeModal();
        };
      };

      deleteEventButton.onclick = function() {
        if (confirm('Are you sure you want to delete this event?')) {
          const eventId = parseInt(eventIdInput.value);
          const transaction = db.transaction(['events'], 'readwrite');
          const objectStore = transaction.objectStore('events');
          objectStore.delete(eventId);
          transaction.oncomplete = function() {
            loadEventsFromDB();
            closeModal();
          };
        }
      };
      
      function updateEventInDB(event) {
        const eventData = {
          id: event.extendedProps.id,
          title: event.title,
          start: event.startStr,
          end: event.endStr,
          allDay: event.allDay,
          category: event.backgroundColor,
          reminder: event.extendedProps.reminder
        };
        const transaction = db.transaction(['events'], 'readwrite');
        const objectStore = transaction.objectStore('events');
        objectStore.put(eventData);
        transaction.oncomplete = loadEventsFromDB;
      }

      function setReminder(eventData) {
        if (!eventData.reminder) return;
        
        const reminderTime = new Date(eventData.start).getTime() - (eventData.reminder * 60000);
        const now = new Date().getTime();

        if (reminderTime > now) {
          setTimeout(() => {
            showNotification(`Reminder: ${eventData.title}`);
          }, reminderTime - now);
        }
      }

      function showNotification(message) {
        if (Notification.permission === 'granted') {
          new Notification(message);
        } else if (Notification.permission !== 'denied') {
          Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
              new Notification(message);
            }
          });
        }
      }
    });
  </script>
</body>
</html>

